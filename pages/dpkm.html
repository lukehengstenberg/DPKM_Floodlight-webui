<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Floodlight OpenFlow Controller - DPKM</title>
    <!-- Bootstrap Core CSS -->
    <link href="../bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- MetisMenu CSS -->
    <link href="../bower_components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">
    <!-- DataTables CSS -->
    <link href="../bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.css"
          rel="stylesheet">
    <!-- DataTables Responsive CSS -->
    <link href="../bower_components/datatables-responsive/css/dataTables.responsive.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="../dist/css/sb-admin-2.css" rel="stylesheet">
    <!-- Custom Fonts -->
    <link href="../bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<div id="wrapper">
    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-static-top" role="navigation" style="margin-bottom: 0">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="index.html" id="home-button-title">Floodlight OpenFlow Controller </a>
        </div>
        <!-- /.navbar-header -->
        <!-- /.navbar-top-links -->
        <div class="navbar-default sidebar" role="navigation">
            <div class="sidebar-nav navbar-collapse">
                <nav id="navMenu"></nav>
            </div>
            <!-- /.sidebar-collapse -->
        </div>
        <!-- /.navbar-static-side -->
    </nav>
    <div id="page-wrapper">
        <div class="row">
            <div class="col-lg-12">
                <h3 class="page-header">DPKM WireGuard-based Encryption</h3>
            </div>
            <!-- /.col-lg-12 -->
        </div>
        <div class="row">
            <div class="col-lg-12">
                <a href="#" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#configureWGModal">Add New
                                                                                                           WireGuard Configuration</a>
            </div>
            <br/><br/>
        </div>
        <!-- /.row -->
        <div class="row">
            <div class="col-lg-12">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        Switches Configured with WireGuard
                    </div>
                    <!-- /.panel-heading -->
                    <div class="panel-body">
                        <div class="dataTable_wrapper">
                            <table class="table table-striped table-bordered table-hover" id="tableWGSwitches"
                                   width="100%">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Switch ID</th>
                                    <th>IPv4 Address</th>
                                    <th>WireGuard Address</th>
                                    <th>Cryptoperiod</th>
                                    <th>Status</th>
                                    <th>Compromised?</th>
                                    <th>Delete</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <!-- /.table-responsive -->
                    </div>
                    <!-- /.panel-body -->
                </div>
                <!-- /.panel -->

            </div>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <a href="#" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#addPeerModal">Add New
                                                                                                           Peer Connection</a>
            </div>
            <br/><br/>
        </div>
        <div class="row">
            <div class="col-lg-12">
                <div class="panel panel-primary">
                    <div class="panel-heading">
                        Switches Connected as WireGuard Peers
                    </div>
                    <!-- /.panel-heading -->
                    <div class="panel-body">
                        <div class="dataTable_wrapper">
                            <table class="table table-striped table-bordered table-hover" id="tableWGPeers"
                                   width="100%">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Switch ID A</th>
                                    <th>IPv4 Address A</th>
                                    <th>WireGuard Address A</th>
                                    <th>Switch ID B</th>
                                    <th>IPv4 Address B</th>
                                    <th>WireGuard Address B</th>
                                    <th>Status</th>
                                    <th>Delete</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <!-- /.table-responsive -->
                    </div>
                    <!-- /.panel-body -->
                </div>
                <!-- /.panel -->

            </div>
        </div>
        <div class="modal fade modal-lg" tabindex="-1" role="dialog" id="configureWGModal" aria-hidden="true">
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" id="configureWGModalCloseButton" data-dismiss="modal"
                                aria-label="Close">
                            <span aria-hidden="true">×</span>
                        </button>
                        <h4 class="modal-title" id="myModalLabel2">Add New WireGuard Configuration</h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="switchSelect">Switch ID</label>
                            <select id="switchId" name="switchSelect">
                                <option selected="selected">Select Switch</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Cryptoperiod(s)</label>
                            <input class="form-control" type="text" id="cryptoperiod" placeholder="Cryptoperiod">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-xs btn-default" data-dismiss="modal">Cancel</button>
                        <button type="button" id="btnConfigureWG" class="btn btn-xs btn-primary" data-dismiss="modal">Configure</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade modal-lg" tabindex="-1" role="dialog" id="addPeerModal" aria-hidden="true">
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" id="addPeerModalCloseButton" data-dismiss="modal"
                                aria-label="Close">
                            <span aria-hidden="true">×</span>
                        </button>
                        <h4 class="modal-title" id="myModalLabel2">Add New Peer Connection</h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="switchSource">Source Switch ID:</label>
                            <select id="switchSource" onchange="updateField('switchSource')" name="switchSource">
                                <option selected="selected">Select Switch</option>
                            </select>
                            <br />
                            <label>IP Address Source:</label>
                            <input class="form-control" type="text" value="" id="switchSourceIP" placeholder="Source IP" readonly />
                        </div>
                        <div class="form-group">
                            <label for="switchTarget">Target Switch ID:</label>
                            <br />
                            <select id="switchTarget" onchange="updateField('switchTarget')" name="switchTarget">
                                <option selected="selected">Select Switch</option>
                            </select>
                            <br />
                            <label>IP Address Target:</label>
                            <input class="form-control" type="text" value="" id="switchTargetIP" placeholder="Target IP" readonly />
                        </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-xs btn-default" data-dismiss="modal">Cancel</button>
                        <button type="button" id="btnAddPeer" class="btn btn-xs btn-primary" data-dismiss="modal">Add Peer</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- /#page-wrapper -->

<div id="login-modal-include"></div>
</div>
<!-- /#wrapper -->
<!-- jQuery -->
<script src="../bower_components/jquery/dist/jquery.min.js"></script>
<!-- Bootstrap Core JavaScript -->
<script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
<!-- Metis Menu Plugin JavaScript -->
<script src="../bower_components/metisMenu/dist/metisMenu.min.js"></script>
<!-- DataTables JavaScript -->
<script src="../bower_components/datatables/media/js/jquery.dataTables.min.js"></script>
<script src="../bower_components/datatables-plugins/integration/bootstrap/3/dataTables.bootstrap.min.js"></script>
<!-- Custom Theme JavaScript -->
<script src="../dist/js/sb-admin-2.js"></script>
<script src="../js/jquery.cookie.js"></script>
<!-- PNotify -->
<script src="../bower_components/pnotify/pnotify.buttons.js"></script>
<script src="../bower_components/pnotify/pnotify.core.js"></script>
<script src="../bower_components/pnotify/pnotify.nonblock.js"></script>
<!-- Page-Level Demo Scripts - Tables - Use for reference -->
<script src="../js/querystringparser.js"></script>

<!-- Custom scripts to load in HTML -->
<script src="../js/navbar.js"></script>
<script>
    $(function () {
        $("#login-modal-include").load("loginmodal.html");
    });
</script>

<script>
    /*
     * These cookies are set on the login page at login.html.
     * They are simply the IP address of your controller and the REST api port.
     * */
    var ipaddress = $.cookie('cip');
    if (ipaddress == null || ipaddress == "") window.location.href = "login.html";
    var restport = $.cookie('cport');
    if (restport == null || restport == "") window.location.href = "login.html";

    $(document).ready(function () {
        LoadSwitches();
        GetWGSwitches();
        GetWGSwitchesModal();
        GetWGPeers();
        startRefresh();
    });

    /*
     * Refreshes all of the values on the page every fifteen seconds.
     * */
    function startRefresh() {
        setTimeout(startRefresh, 15000);
        GetWGSwitches();
        GetWGSwitchesModal();
        GetWGPeers();
    }

    /*
     * Gets all of the connected switches from the controller.
     * */
    function LoadSwitches() {
        $.ajax({
            type    : "GET",
            dataType: 'json',
            url     : " http://" + ipaddress + ":" + restport + "/wm/core/controller/switches/json",

            success: function (data) {
                var result = data;
                var selectIn = "";
                for (var i=0;i<result.length;i++) {
                    var selectSwitch = result[i].switchDPID;
                    selectIn = '<option value='+ selectSwitch +'>'+ selectSwitch +'</option>';
                    var optionValues =[];
                    $('#switchId option').each(function(){
                        if($.inArray(this.value, optionValues) >-1){
                            $(this).remove()
                        }else{
                            optionValues.push(this.value);
                        }
                    });
                    $('#switchId').append(selectIn);
                }
            },
            error  : function (jqXHR, textStatus, errorThrown) {
                alert('Error: ' + " " + jqXHR.responseText + " \n Status: " + textStatus + " \n Error Thrown: " + errorThrown);
            }
        });
    }

    /*
     * Checks the data in the configureWG modal form and calls the ConfigureWGSwitch function.
     * */
    $("#btnConfigureWG").click(function () {
        var switchid = $("#switchId").val();
        var cryptoperiod = $("#cryptoperiod").val();
        if(switchid != "" && cryptoperiod != "") {
            ConfigureWGSwitch(switchid, cryptoperiod);
        } else {
            new PNotify({
                title: 'Enter a value !',
                text : 'Please enter a valid value!',
                type : 'warning',
                hide : true
            });
        }
    });

    /*
     * Post method for sending a DPKM_SET_KEY message and setting the cryptoperiod on success.
     * */
    function ConfigureWGSwitch(switchid, cryptoperiod) {
        var postData = "";
        postData = '{ "switchid":' + "\"" + switchid + "\""
                + ',"cryptoperiod": ' + "\"" + cryptoperiod + "\"" + '}';
        $.ajax({
            type    : "POST",
            dataType: 'json',
            url     : "http://" + ipaddress + ":" + restport + "/wm/dpkm/configure/json",
                    data    : postData,
                    success : function (data) {

                        if (data["status"] == "DPKM_SET_KEY message sent to switch.") {
                            new PNotify({
                                title: 'DPKM_SET_KEY message sent to switch!',
                                text : 'Status response will confirm success.',
                                type : 'success',
                                hide : true
                            });

                            GetWGSwitches();
                        }
                        else {

                            new PNotify({
                                title: 'Error Occured.',
                                text : data["status"],
                                type : 'error',
                                hide : true
                            });
                        }

                    },
                    error   : function (jqXHR, textStatus, errorThrown) {
                        alert('Error: ' + " " + jqXHR.responseText + " \n Status: " + textStatus + " \n Error Thrown: " + errorThrown);
                    }
                });
    }

    /*
     * Gets all of the WireGuard Configured switches from the database.
     * */
     function GetWGSwitches() {

         var url = "http://" + ipaddress + ":" + restport + "/wm/dpkm/retrieve/json";

         $(document).ready(function () {

             $('#tableWGSwitches').DataTable().destroy();

             $('#tableWGSwitches').DataTable({
                 responsive  : true,
                 lengthChange: false,
                 searching: false,
                 scrollX: true,
                 paging: false,
                 ajax        : {
                     url    : url,
                     dataSrc: ''
                 },
                 "columnDefs": [
                     {
                         // The `data` parameter refers to the data for the cell (defined by the
                         // `data` option, which defaults to the column being worked with, in
                         // this case `data: 0`.
                         "render" : function (data, type, row) {
                             return "<a class='btn btn-xs btn-danger' onclick='DeleteSwitch(" + data + ")' >Delete</<a>";
                         },
                         "targets": 7
                     }

                 ],
                 columns     : [
                     {data: 'id'},
                     {data: 'dpid'},
                     {data: 'ipv4Addr'},
                     {data: 'ipv4AddrWG'},
                     {data: 'cryptoperiod'},
                     {data: 'status'},
                     {data: 'compromised'},
                     {data: 'id'},
                 ]
             });

         });

     }

     /*
      *  Delete method for sending a DPKM_DELETE_KEY message on success to the specified switch.
      * */
      function DeleteSwitch(id) {
          if (confirm("Switch will be unconfigured by deleting the key. To continue press 'OK'!")) {

              $.ajax({
                  type    : "DELETE",
                  dataType: 'json',
                  url     : "http://" + ipaddress + ":" + restport + "/wm/dpkm/delete/key/json",
                  data    : '{ "id":' + "\"" + id + "\"" + '}',
                  success : function (data) {

                      new PNotify({
                          title: 'DPKM_DELETE_KEY message sent to switch!',
                          text : 'Status response will confirm success.',
                          type : 'success',
                          hide : true
                      });

                      GetWGSwitches();

                  },
                  error   : function (jqXHR, textStatus, errorThrown) {
                      alert('Error: ' + " " + jqXHR.responseText + " \n Status: "
                              + textStatus + " \n Error Thrown: " + errorThrown);
                  }
              });
          }
      }

      /*
       * Removes the selected source switch as an option in the target switch dropdown.
       * Populates the target switch dropdown with the remaining options.
       * */
      var $switchesSource = $("select[name='switchSource']");
      var $switchesTarget = $("select[name='switchTarget']");
      $switchesSource.change(function() {
          $switchesTarget.empty().append($switchesSource.find('option').clone());
          var selectedSwitch = $(this).val();
          if (selectedSwitch) {
              $switchesTarget.find('option[value="' + selectedSwitch + '"]').remove();
          }
      });

      /*
       * Updates the IP address field based on the selected switch id.
       * */
      function updateField(field) {
          $.ajax({
              type    : "GET",
              dataType: 'json',
              url     : " http://" + ipaddress + ":" + restport + "/wm/dpkm/retrieve/json",

              success: function (data) {
                  var result = data;
                  var selectIn = "";
                  var id = field + 'IP';
                  for (var i=0;i<result.length;i++) {
                      var selectSwitchId = result[i].dpid;
                      var selectSwitchIP = result[i].ipv4Addr;
                      if(document.getElementById(field).value == selectSwitchId) {
                          document.getElementById(id).value = selectSwitchIP;
                      }
                  }
              },
              error  : function (jqXHR, textStatus, errorThrown) {
                  alert('Error: ' + " " + jqXHR.responseText + " \n Status: " + textStatus + " \n Error Thrown: " + errorThrown);
              }
          });
      }

      /*
       * Gets all configured switches from the database populating drop-downs.
       * */
      function GetWGSwitchesModal() {
          $.ajax({
              type    : "GET",
              dataType: 'json',
              url     : " http://" + ipaddress + ":" + restport + "/wm/dpkm/retrieve/json",

              success: function (data) {
                  var result = data;
                  var selectIn = "";
                  for (var i=0;i<result.length;i++) {
                      var selectSwitch = result[i].dpid;
                      selectIn = '<option value='+ selectSwitch +'>'+ selectSwitch +'</option>';
                      var optionsSource =[];
                      $('#switchSource').append(selectIn);
                      $('#switchSource option').each(function(){
                          if($.inArray(this.value, optionsSource) >-1){
                              $(this).remove()
                          }else{
                              optionsSource.push(this.value);
                          }
                      });

                  }
              },
              error  : function (jqXHR, textStatus, errorThrown) {
                  alert('Error: ' + " " + jqXHR.responseText + " \n Status: " + textStatus + " \n Error Thrown: " + errorThrown);
              }
          });
      }

      /*
       * Checks the data in the addPeer modal form and calls the AddPeer function.
       * */
      $("#btnAddPeer").click(function () {
          var switchIdSource = $("#switchSource").val();
          var ipv4Source = $("#switchSourceIP").val();
          var switchIdTarget = $("#switchTarget").val();
          var ipv4Target = $("#switchTargetIP").val();
          if(switchIdSource != "" && ipv4Source != "" && switchIdTarget != "" && ipv4Target != "") {
              AddPeer(switchIdSource, ipv4Source, switchIdTarget, ipv4Target);
          } else {
              new PNotify({
                  title: 'Enter a value !',
                  text : 'Please enter a valid value!',
                  type : 'warning',
                  hide : true
              });
          }
      });

      /*
       * Post method for sending a DPKM_ADD_PEER message to add a new peer connection.
       * */
      function AddPeer(switchIdSource, ipv4Source, switchIdTarget, ipv4Target) {
          var postData = "";
          postData = '{ "switchIdSource":' + "\"" + switchIdSource + "\""
                  + ',"ipv4Source" :' + "\"" + ipv4Source + "\""
                  + ',"switchIdTarget" :' + "\"" + switchIdTarget + "\""
                  + ',"ipv4Target": ' + "\"" + ipv4Target + "\"" + '}';
          $.ajax({
              type    : "POST",
              dataType: 'json',
              url     : "http://" + ipaddress + ":" + restport + "/wm/dpkm/add/peer/json",
                      data    : postData,
                      success : function (data) {

                          if (data["status"] == "DPKM_ADD_PEER message sent to switch.") {
                              new PNotify({
                                  title: 'DPKM_ADD_PEER message sent to switch!',
                                  text : 'Status response will confirm success.',
                                  type : 'success',
                                  hide : true
                              });

                              GetWGPeers();
                          }
                          else {

                              new PNotify({
                                  title: 'Error Occured.',
                                  text : data["status"],
                                  type : 'error',
                                  hide : true
                              });
                          }

                      },
                      error   : function (jqXHR, textStatus, errorThrown) {
                          alert('Error: ' + " " + jqXHR.responseText + " \n Status: " + textStatus + " \n Error Thrown: " + errorThrown);
                      }
                  });
      }

     /*
      * Gets all of the WireGuard Peer connections from the database.
      * */
      function GetWGPeers() {

          var url = "http://" + ipaddress + ":" + restport + "/wm/dpkm/retrieve/peers/json";

          $(document).ready(function () {

              $('#tableWGPeers').DataTable().destroy();

              $('#tableWGPeers').DataTable({
                  responsive  : true,
                  lengthChange: false,
                  searching: false,
                  scrollX: true,
                  paging: false,
                  ajax        : {
                      url    : url,
                      dataSrc: ''
                  },
                  "columnDefs": [
                      {
                          // The `data` parameter refers to the data for the cell (defined by the
                          // `data` option, which defaults to the column being worked with, in
                          // this case `data: 0`.
                          "render" : function (data, type, row) {
                              return "<a class='btn btn-xs btn-danger' onclick='DeletePeer(" + data + ")' >Delete</<a>";
                          },
                          "targets": 8
                      }

                  ],
                  columns     : [
                      {data: 'cid'},
                      {data: 'dpidA'},
                      {data: 'ipv4AddrA'},
                      {data: 'ipv4AddrWGA'},
                      {data: 'dpidB'},
                      {data: 'ipv4AddrB'},
                      {data: 'ipv4AddrWGB'},
                      {data: 'status'},
                      {data: 'cid'},
                  ]
              });

          });

      }

      /*
       *  Delete method for sending a DPKM_DELETE_PEER message on success to the specified switch.
       * */
       function DeletePeer(cid) {
           if (confirm("The chosen peer connection will be deleted. To continue press 'OK'!")) {

               $.ajax({
                   type    : "DELETE",
                   dataType: 'json',
                   url     : "http://" + ipaddress + ":" + restport + "/wm/dpkm/delete/peer/json",
                   data    : '{ "cid":' + "\"" + cid + "\"" + '}',
                   success : function (data) {

                       new PNotify({
                           title: 'DPKM_DELETE_PEER message sent to switch!',
                           text : 'Status response will confirm success.',
                           type : 'success',
                           hide : true
                       });

                       GetWGPeers();

                   },
                   error   : function (jqXHR, textStatus, errorThrown) {
                       alert('Error: ' + " " + jqXHR.responseText + " \n Status: "
                               + textStatus + " \n Error Thrown: " + errorThrown);
                   }
               });
           }
       }

</script>
</body>
</html>
